name: Build AX6000 Firmware

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Free up disk space
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          df -h

      - name: Set up OpenWrt Environment
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone --branch 2410 https://github.com/padavanonly/immortalwrt-mt798x-24.10.git
          ln -sf /workdir/immortalwrt-mt798x-24.10 $GITHUB_WORKSPACE/immortalwrt-mt798x-24.10


      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get -y install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      - name: Update & Install Feeds
        run: |
          cd immortalwrt-mt798x-24.10
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure Firmware
        run: |
          cp config.immortalwrt-padavanonly immortalwrt-mt798x-24.10/.config

          cd immortalwrt-mt798x-24.10
          perl --version
          ls -la target/linux/mediatek/
          cat target/linux/mediatek/Makefile | grep KERNEL
          head -n 200 scripts/kconfig.pl

          make defconfig

      - name: Download Sources
        run: |
          cd immortalwrt-mt798x-24.10
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Build Firmware
        run: |
          cd immortalwrt-mt798x-24.10
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-mt7986-mt60000
          path: bin/targets/mediatek/mt7986/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ax6000-build-${{ github.run_number }}
          files: bin/targets/mediatek/mt7986/*
